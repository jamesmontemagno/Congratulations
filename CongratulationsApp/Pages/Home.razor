@page "/"
@using Microsoft.JSInterop
@inject IJSRuntime JS

<PageTitle>Congratulations</PageTitle>

<!-- Mode Toggle -->
<div class="mode-toggle">
	<button @onclick="ToggleMaloneMode" class="malone-toggle @(isMaloneMode ? "active" : "")">
		@if (isMaloneMode)
		{
			<span>✨ Low Effects</span>
		}
		else
		{
			<span>🌟 Malone Mode</span>
		}
	</button>
</div>

<section class="lyrics-stage">
	<div class="lyrics">
		<p class="line line-1"><span class="ink">My momma called, see you on TV, son</span></p>
		<p class="line line-2"><span class="ink">Said shit done changed ever since we was on</span></p>
		<p class="line line-3"><span class="ink">I dreamed it all ever since I was young</span></p>
		<p class="line line-4"><span class="ink">They said I would be nothing</span></p>
		<p class="line line-5 big loud shimmer"><span class="ink">Now they always say, Congratulations</span></p>
		<p class="line line-6"><span class="ink">Worked so hard, forgot how to vacation</span></p>
		<p class="line line-7"><span class="ink">They ain't never had the dedication</span></p>
		<p class="line line-8"><span class="ink">People hatin', say we changed and, look, we made it</span></p>
		<p class="line line-9 big loud shimmer"><span class="ink">Yeah, we made it</span></p>

		<div class="hint">Click or tap anywhere for confetti ✨</div>
		<div class="github-link">
			<a href="https://github.com/jamesmontemagno/congratulations" target="_blank" rel="noopener">
				<span class="github-icon">⭐</span>
				<span class="github-text">View on GitHub</span>
			</a>
		</div>
	</div>
</section>

<!-- Music embed (fixed bottom center) -->
<div class="music-embed" aria-hidden="false" aria-label="Apple Music player">
	<iframe allow="autoplay *; encrypted-media *;" frameborder="0" height="150" style="width:100%;max-width:660px;overflow:hidden;background:transparent;" sandbox="allow-forms allow-popups allow-same-origin allow-scripts allow-storage-access-by-user-activation allow-top-navigation-by-user-activation" src="https://embed.music.apple.com/us/album/congratulations-feat-quavo/1440888125?i=1440889023" title="Play: Congratulations - Post Malone feat. Quavo"></iframe>
</div>

@code {
	private bool isMaloneMode = false;

	protected override async Task OnAfterRenderAsync(bool firstRender)
	{
		if (firstRender)
		{
			try
			{
				// Set initial mode class
				await JS.InvokeVoidAsync("document.body.classList.add", "low-effects");
				
				await JS.InvokeVoidAsync("CongratsFX.init");
				// Kick off looping animations of lyrics with longer cycle for dramatic timing
				await JS.InvokeVoidAsync("CongratsFX.playLyricsLoop", ".lyrics", 18000, new { 
					congratsDelayMs = 6200,
					finalDelayMs = 12500
				});
			}
			catch { /* no-op */ }
		}
	}

	private async Task ToggleMaloneMode()
	{
		isMaloneMode = !isMaloneMode;
		
		try
		{
			if (isMaloneMode)
			{
				await JS.InvokeVoidAsync("document.body.classList.remove", "low-effects");
				await JS.InvokeVoidAsync("document.body.classList.add", "malone-mode");
			}
			else
			{
				await JS.InvokeVoidAsync("document.body.classList.remove", "malone-mode");
				await JS.InvokeVoidAsync("document.body.classList.add", "low-effects");
			}
			
			// Re-initialize sparkles for new mode
			await JS.InvokeVoidAsync("window.sparklesOnModeChange");
		}
		catch { /* no-op */ }
	}
}
